---
layout: post
title:  "How to: Configure Citrix XenApp/XenDesktop to use Microsoft SQL multi-subnet (Basic) Availability Groups"
date:   2018-03-07 15:14:00 +0100
categories:  Citrix, Clustering, XenDesktop, AlwaysOn, BAGs, SQL Server 2016 Standard, How to, SQL Server, Failover, Basic Availability Groups, XenApp
---

In the previous blogs I’ve explained you “[How to: Install and configure Microsoft SQL Server 2016 Standard multi-subnet Basic Availability Groups for Citrix XenDesktop and XenMobile](https://patrickvandenborn.blogspot.nl/2017/11/how-to-install-and-configure-microsoft.html)” and “[Microsoft SQL and Microsoft SQL AlwaysOn basics for Citrix Admins](https://patrickvandenborn.blogspot.nl/2018/01/microsoft-sql-and-microsoft-sql.html)”.  
   
This blog is a guide for configuring Citrix XenApp/XenDesktop with a multisubnet SQL AlwaysOn Datastore. When using a MultiSubnet SQL AlwaysOn SQL Cluster, you have to reconfigure all the XenDesktop connection strings to use the **MultiSubnetFailover=True** feature.  
  
For your information: Configuring **MultiSubnetFailover=True** connection string is only possible using powershell at this moment. **MultiSubnetFailover=False** is the default setting after a new site installation.  
  
During a customer’s project I’ve created the following XenDesktop backend:  

*   One XenDesktop Site called: “PBO-LAB”
*   Two Zones

*   Primary Zone: “Amersfoort” containing two delivery controllers
    *   AMF-DDC001
    *   AMF-DDC002

*   Secondary Zone: “Nijkerk” containing two delivery controllers
    *   NRK-DDC003
    *   NRK-DDC004

*   The VDA’s connecting to the corresponding delivery controller in their corresponding site.

*   Two GPO’s are configured. Both with the Citrix Policy “Controllers” for the corresponding site.

Logical overview:  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image002.png)](https://1.bp.blogspot.com/-aHKHzOMXJI4/Wp_daioOTYI/AAAAAAAACgQ/cQwVytXaiEsyVON9o2untTn3h5-lVVb5QCEwYBhgL/s1600/image002.png)
  
**Note:** Site-to-site network latency is 4ms.  

Create the initial databases
----------------------------
Before setting up a new XenDesktop Site, we need to create three empty databases and join them to a (Basic) AlwaysOn Availability Groups. You can do this as follows:  
  
1.    Open SQL Management Studio and connect to one of your SQL Servers  

2.    Right click **databases --> New Database…**  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image003.png)]({{ site.url }}/images/2018-03-07/2018-03-07-image003.png)
  
3.    Enter the Citrix Site database name, for example “**XD-Site**”:  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image004.png)](https://1.bp.blogspot.com/-LQuTLxU-AIA/Wp_dauJFNpI/AAAAAAAACgU/C2gPVSYQ7wkjbeuDCb5xldxMh28SjzWwwCEwYBhgL/s1600/image004.png)
  
4.    Click **Options**. Make sure you configure the following:  
               Collation: **Latin1\_General\_100\_CI\_AS\_KS**  
               Recovery model: **Full**  
               Is Read Committed Snapshot On: **True**  

[![]({{ site.url }}/images/2018-03-07/2018-03-07-image005.png)](https://4.bp.blogspot.com/-WabxmysvM44/Wp_dbKOnWtI/AAAAAAAACgc/3r4CKdfEgGECGf2X6qjJ4qRq_epIxvV-wCEwYBhgL/s1600/image005.png)
  
5.    Create an empty “**Logging**” and “**Monitoring**” database with the same procedure. You will have three databases in the end:  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image006.png)]({{ site.url }}/images/2018-03-07/2018-03-07-image006.png)

Joining the Citrix XenDesktop databases to (Basic) AlwaysOn Availability Group(s)
---------------------------------------------------------------------------------
Now we need to join the **XD-Site**, **XD-Logging** and **XD-Monitoring** databases to AlwaysOn Availability Groups. Since I’m using SQL 2016 Standard I will create three different Basic Availability Groups as follows:  
  
1.    As a prerequisite for AlwaysOn, backup all three databases. Right click the database, choose **Tasks --> Back Up..**  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image007.png)](https://3.bp.blogspot.com/-DDLX5t9_6Q4/Wp_db1e7x2I/AAAAAAAACgc/TGNwojUfK7Qyl7lhqnL231-m8WQMEAkCQCEwYBhgL/s1600/image007.png)
  
2.    Create a Full file backup of the database:  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image008.png)](https://1.bp.blogspot.com/-xmiBhrh3zXs/Wp_dcc6LMQI/AAAAAAAACgc/FlvJBX_w_SQ7uB4lnXJygdF0BcVvL8puwCEwYBhgL/s1600/image008.png)

3.    In SQL Studio, Right Click **Availability Groups** and choose **New Availability Group Wizard…**  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image009.png)]({{ site.url }}/images/2018-03-07/2018-03-07-image009.png)
  
4.    Click **Next**  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image010.png)](https://1.bp.blogspot.com/-supR1AH_BM8/Wp_ddEI3qWI/AAAAAAAACgg/V-Ac_Da_MRgnlQ_FoqMJOPPfd6I1lhUZQCEwYBhgL/s1600/image010.png)
  
5.    Specify the **Availability Group name** and click **next**  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image011.png)](https://2.bp.blogspot.com/-EjRZc3j4C2M/Wp_ddZqzgdI/AAAAAAAACgQ/hGAUtBJEvzQ5XihCRvkoJwOYUvjb1NQEQCEwYBhgL/s1600/image011.png)
  
6.    Select the database to join the Availability group and click **Next**:  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image012.png)](https://3.bp.blogspot.com/-7l_B7Nf9xrc/Wp_ddvASOpI/AAAAAAAACgc/FfWmVLk8UUkmIjEkTLeQMLlZJuCaEgF6ACEwYBhgL/s1600/image012.png)
  
7.    Click **Add Replica**  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image013.png)](https://2.bp.blogspot.com/-5ePHKCSRkm8/Wp_dd4MX9dI/AAAAAAAACgc/j9EIyEmOvM0MKJ8kSoRcVXFBq2SoEPROACEwYBhgL/s1600/image013.png)
  
8.    Login to your second SQL server:  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image014.png)](https://3.bp.blogspot.com/-ghS8rPYE8Ak/Wp_dedBhvuI/AAAAAAAACgc/PVDHQPs5InMq97XsAM9O4R6uJifbXAlrwCEwYBhgL/s1600/image014.png)
  
9.    Select “**Automatic Failover**” and ensure Availability Mode “**Synchronous Commit**”. Click **listener** tab:  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image015.png)](https://4.bp.blogspot.com/-1osIjTrCTkc/Wp_deQbHVQI/AAAAAAAACgY/2aKhGYft4UkMZBKT8yhXKklpwEB7MqT6gCEwYBhgL/s1600/image015.png)
  
10.    Configure a **DNS-name** and **IP-addresses** in both subnets for the listener  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image016.png)](https://1.bp.blogspot.com/-FmY0EzuF7CM/Wp_dedk0IKI/AAAAAAAACgg/tGnGGcM9BUQ_3TCunIy3hcSxXS5Ek78IQCEwYBhgL/s1600/image016.png)
  
11.    Use a temporary SMB File share for seeding the database, click **Next**  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image017.png)](https://4.bp.blogspot.com/-DDv18SLj8zk/Wp_de1uP_CI/AAAAAAAACgY/jQTPBjwhCfEawXBhYE9amz822urPcLPCwCEwYBhgL/s1600/image017.png)
  
12.    Validation completed successfully, click **next**  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image018.png)](https://2.bp.blogspot.com/-NfYQDaBzAmM/Wp_dfDIbJLI/AAAAAAAACgg/tnh8Auq0X5gBCtAIVvj7pnZNSHTL1HDQwCEwYBhgL/s1600/image018.png)
  
13.    Click **Next**  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image019.png)](https://1.bp.blogspot.com/-F_dH7prFzW4/Wp_dfjg2VDI/AAAAAAAACgc/GLqyRcZfzUMZPOXyhPzEoaftA2vFtdgdACEwYBhgL/s1600/image019.png)
  
14.    SQL is creating the **Availability Group** for you:  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image020.png)](https://1.bp.blogspot.com/-XjRalTEPdS0/Wp_dgK9R1xI/AAAAAAAACgc/HJXOvc3qUlUL06mTdqK3ZqiX7CRzhxPPACEwYBhgL/s1600/image020.png)
  
15.    Done, Click **Close**:  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image021.png)](https://2.bp.blogspot.com/-2MZpfEUAyCM/Wp_dgYTO5vI/AAAAAAAACgg/-9oeZfyD0S0owuKyQL5B6l2d82OmcosJQCEwYBhgL/s1600/image021.png)
  
16.    Create a Availability Group for the **Logging** **database**:  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image022.png)](https://2.bp.blogspot.com/-h6C0jZnBqCA/Wp_dg-VERxI/AAAAAAAACgY/yYxcslnt_D0Xk5RFOk42AJmO2BL7Vz9kACEwYBhgL/s1600/image022.png)
  
17.    Create a Availability Group for the **Monitoring database**  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image023.png)](https://4.bp.blogspot.com/-ZW3M4yVZm-Y/Wp_dhQeGqmI/AAAAAAAACgQ/0B0l-tQgHEU0a3khJvw0DI1_AuGSDTXoQCEwYBhgL/s1600/image023.png)
  
18.    You will having three Availability Groups in the end:  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image024.png)]({{ site.url }}/images/2018-03-07/2018-03-07-image024.png)

Configure Citrix XenDesktop to use the MultiSubnetFailover Availability Group
-----------------------------------------------------------------------------
Since we’re now having empty Site, Monitoring and Logging databases in three different Basic Availability Groups, we can now install and configure XenDesktop to use these databases as follows:  
  
1.    Install the Citrix Delivery Controller software like you’ve always do:  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image025.png)](https://3.bp.blogspot.com/-Rqz4rRrlNiE/Wp_dhZb56KI/AAAAAAAACgc/KItP77dXoGwxjdTuH81w2XOAyQL6duX8QCEwYBhgL/s1600/image025.png)
  
2.    Launch Citrix Studio and start “**Site setup**”  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image026.png)](https://1.bp.blogspot.com/-Bz_nibm1o8k/Wp_dhmBWivI/AAAAAAAACgg/tW8uk6oQIzci8jXL7TvS2Y9QEePVlHG0ACEwYBhgL/s1600/image026.png)
  
3.    Select “**A fully configured, production-ready Site**” and enter your “**Site name**”, click **Next**  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image027.png)](https://3.bp.blogspot.com/-GD9HSMtAtLw/Wp_dh2I3tmI/AAAAAAAACgc/CZf71RyT7bwXUXgTVaGLg0UAUATrTfrFgCEwYBhgL/s1600/image027.png)
  
4.    Here’s where you configure the FQDN’s for the three SQL Availability Groups with their corresponding database name. Click **Next**  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image028.png)](https://1.bp.blogspot.com/-kICsKLnHfh4/Wp_didYvTOI/AAAAAAAACgY/DcJxWyvCV9MQdfhjpgBGEo_ArNXVg4-0QCEwYBhgL/s1600/image028.png)
  
5.    Configure your Licensing and Click **Next**  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image029.png)](https://1.bp.blogspot.com/-JxsP1Y3PQ5Y/Wp_di0allzI/AAAAAAAACgc/ykBf8pOO-4UfcLVW8L7X8gkkLn6kIoKwQCEwYBhgL/s1600/image029.png)
  
6.    Configure your hosting connection, click **Next**  

[![]({{ site.url }}/images/2018-03-07/2018-03-07-image030.png)](https://3.bp.blogspot.com/-f4zDP98dmzc/Wp_djAjDfpI/AAAAAAAACgQ/99JqrMfTp9ATaYMqnTfe_mdQNNFjXjv4QCEwYBhgL/s1600/image030.png)

7.    Configure your features and click **Next**  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image031.png)](https://2.bp.blogspot.com/-S1u1X7P3dBI/Wp_djgJGgSI/AAAAAAAACgU/fUa3WDLRv4448CB7atJYg1iOIp0lf_rCACEwYBhgL/s1600/image031.png)
  
8.    Summary of your site configuration. Verify the SQL information and click **Next**  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image032.png)](https://4.bp.blogspot.com/-kCtqu9OJTSk/Wp_dkMnzN2I/AAAAAAAACgU/9RPEroY9XlEYN1tvKo_kK6SZlrONKY3wwCEwYBhgL/s1600/image032.png)

9.    The site and databases are configured  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image033.png)]({{ site.url }}/images/2018-03-07/2018-03-07-image033.png)

Configuring MutliSubnetFailover=true connection string
------------------------------------------------------
Your site is now configured using SQL AlwaysOn using **MultiSubnetFailover=False** by default. If you are using a single subnet AlwaysOn configuration, your good now. When using a MultiSubnet AlwaysOn configuration you need additional configuration, although everything will appear to work correctly.  
  
Let me explain a bit: Since we’ve configured two IP’s in different subnets for the listeners, Windows Failover Clustering will configure both IPs in DNS:  

<table border="1" cellpadding="0" cellspacing="0" class="MsoTableGrid" style="border-collapse: collapse; border: none; mso-border-alt: solid windowtext .5pt; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-yfti-tbllook: 1184;"><tbody><tr style="mso-yfti-firstrow: yes; mso-yfti-irow: 0; mso-yfti-lastrow: yes;"><td style="border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 0cm 5.4pt 0cm 5.4pt; width: 450.8pt;" valign="top" width="601"><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">C:\Windows\system32&gt;nslookup</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Default Server:<span style="mso-spacerun: yes;">&nbsp; </span>PBO-DC01.pbo.lan</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Address:<span style="mso-spacerun: yes;">&nbsp; </span>10.9.0.10</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><br></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">&gt; bag-xd-site.pbo.lan</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Server:<span style="mso-spacerun: yes;">&nbsp; </span>PBO-DC01.pbo.lan</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Address:<span style="mso-spacerun: yes;">&nbsp; </span>10.9.0.10</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><br></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Name:<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>bag-xd-site.pbo.lan</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Addresses:<span style="mso-spacerun: yes;">&nbsp; </span><b style="mso-bidi-font-weight: normal;">10.9.0.222</b></span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b style="mso-bidi-font-weight: normal;">10.11.0.222</b></span></i></span></div></td></tr></tbody></table>
  
Since only one SQL node is able to read and write to the SQL-database, Windows Failover Clustering controls which listener IP is Online and which one is Offline. In this screenshot, when the SQL node in subnet 10.9.0.0/24 fails. The listener IP 10.11.0.222 will come online and IP 10.9.0.222 will go offline:  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image034.png)](https://2.bp.blogspot.com/-f79OKZ7B_Nw/Wp_dkd1q0pI/AAAAAAAACgU/1_88aQx-vWog2lwMGkEkd833FgWXIkAnACEwYBhgL/s1600/image034.png)
  
We’re using the Fully Qualified DNS name of the SQL AlwaysOn listener for the connection. Windows and another operating system will contact one of the IP-addresses of the DNS-record by a round-robin mechanism. This is like Russian roulette if the on-line IP is resolved by the round-robin mechanism.  
  
So this is the point the **MultiSubnetFailover=True** connection string is needed. When a SQL connection is configured with **MutliSubnetFailover=True**, the SQL driver knows about the multi-subnet configuration and will figure out which IP is online and will try to failover to the other one when a SQL node will become inactive. So it is a good idea to configure this feature for your XenDesktop Delivery Controllers. So configure it on all of your delivery controllers as follows:  
1.    Login to your Citrix Desktop Delivery Controller  
2.    Close all Citrix Studio consoles on this Delivery Controller  
3.    I’ve updated the script from [https://support.citrix.com/article/CTX216504](https://support.citrix.com/article/CTX216504), so it supports more availability groups. You can download it here [https://vandenbornit-my.sharepoint.com/:u:/g/personal/patrick\_vandenborn\_it/ERQDUZeX\_aZOt1abpabdwY4B7VpcMFFn3BfZFZ8g4eY5Sg?e=ldst8n](https://vandenbornit-my.sharepoint.com/:u:/g/personal/patrick_vandenborn_it/ERQDUZeX_aZOt1abpabdwY4B7VpcMFFn3BfZFZ8g4eY5Sg?e=ldst8n) or copy paste it from below:  

<table border="1" cellpadding="0" cellspacing="0" class="MsoTableGrid" style="border-collapse: collapse; border: none; mso-border-alt: solid windowtext .5pt; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-yfti-tbllook: 1184;"><tbody><tr style="mso-yfti-firstrow: yes; mso-yfti-irow: 0; mso-yfti-lastrow: yes;"><td style="border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 0cm 5.4pt 0cm 5.4pt; width: 828.85pt;" valign="top" width="1105"><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">######################</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">#</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;"># Updated script for SQL Basic availability Group</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">#</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;"># Sources: https://support.citrix.com/article/CTX216504</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i>#</i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i># Patrick van den Born 15-02-2018</i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i>#</i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i>########################</i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><br></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i>#Vars</i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i>$SiteBAGName = "BAG-XD-Site.pbo.lan"</i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i>$SiteDBName = "XD-Site"</i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i>$LogBAGName = "BAG-XD-Logging.pbo.lan"</i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i>$LogDBName = "XD-Logging"</i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">$MonitorBAGName = "BAG-XD-Monitori.pbo.lan"</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">$MonitorDBName = "XD-Monitoring"</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">$cs="Server=$SiteBAGName;Initial Catalog=$SiteDBName;Integrated Security=True;MultiSubnetFailover=True"</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Write-Host $cs</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">$csLogging= "Server=$LogBAGName;Initial Catalog=$LogDBName;Integrated Security=True;MultiSubnetFailover=True"</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Write-Host $csLogging</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">$csMonitoring = "Server=$MonitorBAGName;Initial Catalog=$MonitorDBName;Integrated Security=True;MultiSubnetFailover=True"</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Write-Host $csMonitoring</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><br></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">#Add Snapin</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Add-PSSnapin Citrix*</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><br></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">#Disable logging</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">set-logsite -state "Disabled"</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><br></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">#Clear connections</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-AnalyticsDBConnection -DBConnection $null -force<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>#<span style="mso-spacerun: yes;">&nbsp; </span>7.6 and newer</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-AppLibDBConnection -DBConnection $null -force <span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span># 7.8 and newer</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-OrchDBConnection -DBConnection $null -force<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>#<span style="mso-spacerun: yes;">&nbsp; </span>7.11 and newer</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-TrustDBConnection -DBConnection $null -force<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>#<span style="mso-spacerun: yes;">&nbsp; </span>7.11 and newer</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-HypDBConnection -DBConnection $null -force</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-ProvDBConnection -DBConnection $null -force</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-BrokerDBConnection -DBConnection $null -force</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-EnvTestDBConnection -DBConnection $null -force</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-SfDBConnection -DBConnection $null -force</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-MonitorDBConnection -DataStore Monitor -DBConnection $null -force</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-MonitorDBConnection -DBConnection $null -force</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-LogDBConnection -DataStore Logging -DBConnection $null -force</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-LogDBConnection -DBConnection $null -force</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-ConfigDBConnection -DBConnection $null<span style="mso-spacerun: yes;">&nbsp; </span>-force</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-AcctDBConnection -DBConnection $null -force</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-AdminDBConnection -DBConnection $null -force</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><br></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">#Set Multisubnet connections</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-AdminDBConnection -DBConnection $cs</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-ConfigDBConnection -DBConnection $cs</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-AcctDBConnection -DBConnection $cs</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-AnalyticsDBConnection -DBConnection $cs<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span># 7.6 and newer</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-HypDBConnection -DBConnection $cs<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-ProvDBConnection -DBConnection $cs</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-AppLibDBConnection –DBConnection $cs<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>#<span style="mso-spacerun: yes;">&nbsp; </span>7.8 and newer</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-OrchDBConnection –DBConnection $cs<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span># 7.11 and newer</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-TrustDBConnection –DBConnection $cs<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>#<span style="mso-spacerun: yes;">&nbsp; </span>7.11 and newer</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-PvsVmDBConnection -DBConnection $cs<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span># PBO: Will fail, maybe needed by older DDCs</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-BrokerDBConnection -DBConnection $cs</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-EnvTestDBConnection -DBConnection $cs</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-SfDBConnection -DBConnection $cs</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-LogDBConnection -DBConnection $cs</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-LogDBConnection -DataStore Logging -DBConnection $csLogging</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-MonitorDBConnection -DBConnection $cs</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Set-MonitorDBConnection -DataStore Monitor -DBConnection $csMonitoring</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><br></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">#Enable logging</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">set-logsite -state "Enabled"</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><br></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">#Get connection strings</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Write-Host "Configured connection strings for this controller"</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Get-AdminDBConnection</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Get-AcctDBConnection</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Get-AnalyticsDBConnection<span style="mso-spacerun: yes;">&nbsp;&nbsp; </span># 7.6 and newer</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Get-HypDBConnection<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;</span></span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Get-ProvDBConnection</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Get-AppLibDBConnection<span style="mso-spacerun: yes;">&nbsp; </span>#<span style="mso-spacerun: yes;">&nbsp; </span>7.8 and newer</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Get-OrchDBConnection<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span># 7.11 and newer</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Get-TrustDBConnection<span style="mso-spacerun: yes;">&nbsp;&nbsp; </span>#<span style="mso-spacerun: yes;">&nbsp; </span>7.11 and newer</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Get-BrokerDBConnection</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Get-EnvTestDBConnection</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Get-SfDBConnection</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Get-LogDBConnection</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Get-LogDBConnection -DataStore Logging</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Get-MonitorDBConnection</span></i></span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i></i></span><br><div class="MsoNormal" style="line-height: normal; margin-bottom: .0001pt; margin-bottom: 0cm;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><i><span lang="EN-US" style="mso-ansi-language: EN-US;">Get-MonitorDBConnection -DataStore Monitor</span></i></span></div></td></tr></tbody></table>
  
4.    Just fill out the following vars **SiteBAGName**, **SiteDBName**, **LogBAGName**, **LogDBName**, **MonitorBAGName** and **MonitorDBName**.  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image035.png)](https://3.bp.blogspot.com/-zroHFqBUyFM/Wp_dkTnZPZI/AAAAAAAACgY/z6SJn1iVOyw5subKqEhWTLdO6Aq9JY4SgCEwYBhgL/s1600/image035.png)

_Experience: Disable Logging temporary, otherwise you will stuck at reconfiguring the connection strings. Cause: Logging DB connection is cleared and Citrix want to log everything even when not possible (logdb is down). _  
  
5.    Run the script to reconfigure the SQL connections for this Desktop Delivery Controller:  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image036.png)](https://4.bp.blogspot.com/-vFNeKs-r5Qc/Wp_dknCUYjI/AAAAAAAACgg/9arzBq4e6w0z3gQcxvSQvyTuSMkFaIjVwCEwYBhgL/s1600/image036.png)
  
6.    At the end of the script you will have an overview of all the reconfigured connections  
[![]({{ site.url }}/images/2018-03-07/2018-03-07-image037.png)](https://3.bp.blogspot.com/-4vVB_0vpwgk/Wp_dk1Z9YHI/AAAAAAAACgc/pVZDyuBUeWwEPq6gGnydywhHf0vCwk3pwCEwYBhgL/s1600/image037.png)
 
7.    Execute the script on all of your Delivery Controllers in your site.  
Now Citrix XenDesktop is configured for MultiSubnet SQL AlwaysOn Availability Group!